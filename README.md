# Stock Market Time Series Analysis and Backtesting Framework

This repository provides a comprehensive framework for preparing, analyzing, and modeling stock market tick data. The project is comprised of multiple modules that work together to:

- Load and preprocess raw timeseries data
- Engineer relevant features for predictive modeling
- Train CatBoost models to forecast asset returns over various time intervals
- Backtest trading strategies based on model predictions
- Conduct detailed monthly and intraday analysis via interactive notebooks

## Project Structure
    .
    ├── README.md
    ├── create_dataset.py # Loads H5 files, cleans data, splits data into training/test sets, and prepares NumPy datasets
    ├── feature_engineering.py # Computes returns, volatility, volume changes, price imbalances, and time bins
    ├── catboost_model.py # Trains CatBoost regression models for different target return horizons (1min, 5min, 10min, 1h)
    ├── backtrade.py # Implements a backtesting framework to simulate trade execution using model-generated signals
    ├── monthly_analysis.ipynb # Jupyter Notebook for monthly aggregation analysis and visualization
    ├── intraday_analysis_interactive.ipynb # Interactive Jupyter Notebook for intraday analysis with ipywidgets and matplotlib
    ├── data/ # Raw input H5 data files (named as {stock_symbol}{yyyymmdd}.h5)
    ├── dataset/ # Prepared training and testing datasets saved as NumPy arrays
    ├── figures/ # Folder where generated figures are stored
    └── models/ # Folder where trained CatBoost models and training results are stored



## Features

### Data Preparation
- **Loading Data:**  
  The `create_dataset.py` module reads H5 files from the `data/` folder, extracts tick-level data based on expected file naming (e.g., `002521_20220930.h5`), and converts timestamp fields to proper datetime objects.
  
- **Cleaning Data:**  
  Zero-value columns (and rows where key fields like `LastPrice` or `Volume` are zero) are dropped for data quality. It also splits the data into training and test sets based on a provided split date.

- **Dataset Preparation:**  
  The cleaned data is transformed into NumPy arrays for features and labels. These arrays are saved in the `dataset/` folder for easy loading during model training.

### Feature Engineering
- **Returns & Volatility:**  
  Returns are computed over multiple time windows including 1 minute, 5 minutes, 10 minutes, and 1 hour. The module also calculates rolling volatility and realized volatility based on price returns.
  
- **Volume and Order Flow:**  
  Volume change and other metrics such as the number of trades and the imbalance between ask and bid prices are computed. A weighted imbalance price is also derived to capture order book dynamics.

- **Time Binning:**  
  Data is grouped into uniform time bins (e.g., 5-minute intervals) to facilitate time-based aggregation and analysis.

### Model Training
- **CatBoost Models:**  
  The `catboost_model.py` script demonstrates training separate CatBoost regression models for each target return horizon. It uses specified hyperparameters (e.g., iterations, learning rate, depth, regularization) and supports GPU acceleration.
  
- **Evaluation and Saving:**  
  After training, models are evaluated using metrics such as Mean Absolute Error (MAE). The trained models and training parameters are saved in the `models/` directory.

### Backtesting Framework
- **Simulated Trading:**  
  The `backtrade.py` module implements a backtester that simulates trade execution based on model predictions. It manages opening/closing positions, calculates realized profit/loss (including transaction costs), and constructs an equity curve.
  
- **Signal Generation:**  
  Trading signals (e.g., LONG, SHORT, HOLD, CLOSE) are generated by processing the model predictions along with considerations of trading time windows.
  
- **Performance Metrics:**  
  The backtesting module calculates key performance metrics such as the Sharpe Ratio and supports interactive visualizations of equity curves and trade markers.

### Analysis Notebooks
- **Monthly Analysis:**  
  The `monthly_analysis.ipynb` notebook aggregates metrics (e.g., volume change, price change) over monthly intervals, performs correlation analysis, and generates visualizations identifying key time segments.
  
- **Intraday Interactive Analysis:**  
  The `intraday_analysis_interactive.ipynb` notebook uses ipywidgets to allow interactive exploration of price, volume, and order book dynamics on an intraday basis.

## Installation

Ensure you have Python 3.12 or later. Install the required packages via pip:

```bash
pip install numpy pandas h5py catboost scikit-learn backtrader matplotlib ipywidgets
```

> **Note:** If you plan on using GPU acceleration with CatBoost, verify that your GPU drivers and prerequisites are properly installed.

## Usage

### Data Preparation
To load and prepare data from your raw H5 files, run:
```bash
python create_dataset.py
```

```bash
python catboost_model.py --dimension all
```

You can specify specific target dimensions (e.g., "0,2") via the `--dimension` argument.

### Backtesting
To perform a backtest using your pretrained model(s), run:

```bash
python backtrade.py --model <path_to_model_or_directory> --plot
```

The `--plot` argument will display the equity curve and trade markers after the backtest.

### Data Analysis
Launch the provided Jupyter notebooks to conduct detailed analysis:
- **Monthly Analysis:** Open `monthly_analysis.ipynb`
- **Intraday Analysis:** Open `intraday_analysis.ipynb`
